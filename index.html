<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Contrôle Séchoir</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    h2 { margin-top: 30px; }
    .card {
      display: inline-block;
      background: white;
      padding: 20px;
      margin: 20px;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .val-box {
      margin-top: 10px;
      padding: 8px;
      background: #222;
      color: #fff;
      border-radius: 5px;
      display: inline-block;
      width: 80px;
    }
    .control { margin-top: 15px; }
    input[type=range] { width: 150px; }
    button { margin: 0 5px; padding: 5px 10px; }
  </style>
</head>
<body>
  <h1>Tableau de Bord Séchoir</h1>
  <div class="card">
    <h2>Température (°C)</h2>
    <canvas id="tempChart" width="200" height="200"></canvas>
    <div class="val-box" id="tempVal">0°C</div>
  </div>
  <div class="card">
    <h2>Humidité (%)</h2>
    <canvas id="humChart" width="200" height="200"></canvas>
    <div class="val-box" id="humVal">0%</div>
  </div>
  <div class="card">
    <h2>Consigne Température</h2>
    <button onclick="adjustValue('consigneTemp', -1)">-</button>
    <input type="range" id="consigneTemp" min="30" max="80" value="60" oninput="updateValue(this.id, this.value)">
    <button onclick="adjustValue('consigneTemp', 1)">+</button>
    <div class="val-box" id="consigneTempVal">60°C</div>
  </div>
  <div class="card">
    <h2>Kp / Ki / Kd</h2>
    <div>
      <label>Kp</label>
      <button onclick="adjustValue('Kp', -0.1)">-</button>
      <input type="range" id="Kp" min="0" max="10" step="0.1" value="5" oninput="updateValue(this.id, this.value)">
      <button onclick="adjustValue('Kp', 0.1)">+</button>
      <div class="val-box" id="KpVal">5.0</div>
    </div>
    <div>
      <label>Ki</label>
      <button onclick="adjustValue('Ki', -0.1)">-</button>
      <input type="range" id="Ki" min="0" max="5" step="0.1" value="0.5" oninput="updateValue(this.id, this.value)">
      <button onclick="adjustValue('Ki', 0.1)">+</button>
      <div class="val-box" id="KiVal">0.5</div>
    </div>
    <div>
      <label>Kd</label>
      <button onclick="adjustValue('Kd', -0.1)">-</button>
      <input type="range" id="Kd" min="0" max="5" step="0.1" value="1.0" oninput="updateValue(this.id, this.value)">
      <button onclick="adjustValue('Kd', 0.1)">+</button>
      <div class="val-box" id="KdVal">1.0</div>
    </div>
  </div>
  <script>
    let tempChart = new Chart(document.getElementById('tempChart'), {
      type: 'doughnut',
      data: { labels: ['Temp', 'Reste'], datasets: [{ data: [0, 100], backgroundColor: ['#e63946', '#ccc'] }] },
      options: { cutout: '70%', responsive: false }
    });
    let humChart = new Chart(document.getElementById('humChart'), {
      type: 'doughnut',
      data: { labels: ['Humidité', 'Reste'], datasets: [{ data: [0, 100], backgroundColor: ['#457b9d', '#ccc'] }] },
      options: { cutout: '70%', responsive: false }
    });
    function adjustValue(id, delta) {
      let el = document.getElementById(id);
      el.value = parseFloat(el.value) + delta;
      updateValue(id, el.value);
    }
    function updateValue(id, value) {
      document.getElementById(id + 'Val').innerText = value + (id.includes('Temp') ? '°C' : '');
      let url = '/setPID';
      if (param.includes('K') || param.includes('Temp')) {
        let data = new URLSearchParams();
        data.append(id, value);
        fetch(url, { method: 'POST', body: data });
      }
    }
    function refreshMetrics() {
      fetch('/metrics')
        .then(res => res.json())
        .then(data => {
          tempChart.data.datasets[0].data = [data.temp, 100 - data.temp];
          humChart.data.datasets[0].data = [data.hum, 100 - data.hum];
          tempChart.update();
          humChart.update();
          document.getElementById('tempVal').innerText = data.temp + '°C';
          document.getElementById('humVal').innerText = data.hum + '%';
        });
    }
    setInterval(refreshMetrics, 1000);
  </script>
</body>
</html>