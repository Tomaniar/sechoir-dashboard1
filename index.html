<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Contrôle Séchoir</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    h2 { margin-top: 30px; }
    .card {
      display: inline-block;
      background: white;
      padding: 20px;
      margin: 20px;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .val-box {
      margin-top: 10px;
      padding: 8px;
      background: #222;
      color: #fff;
      border-radius: 5px;
      display: inline-block;
      width: 80px;
    }
    .control { margin-top: 15px; }
    button { 
      margin: 0 5px; 
      padding: 5px 10px;
      cursor: pointer;
    }
    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      border-radius: 15px;
      font-weight: bold;
    }
    .connected { background: #4CAF50; color: white; }
    .disconnected { background: #f44336; color: white; }
  </style>
</head>
<body>
  <div id="connectionStatus" class="connection-status disconnected">ESP32 Déconnecté</div>

  <h1>Tableau de Bord Séchoir</h1>

  <div class="card">
    <h2>Température (°C)</h2>
    <canvas id="tempChart" width="200" height="200"></canvas>
    <div class="val-box" id="tempVal">--°C</div>
  </div>

  <div class="card">
    <h2>Humidité (%)</h2>
    <canvas id="humChart" width="200" height="200"></canvas>
    <div class="val-box" id="humVal">--%</div>
  </div>

  <div class="card">
    <h2>Consigne Température</h2>
    <button onclick="adjustValue('consigneTemp', -1)">-</button>
    <span id="consigneTempVal" class="val-box">60°C</span>
    <button onclick="adjustValue('consigneTemp', 1)">+</button>
    <input type="hidden" id="consigneTemp" value="60">
  </div>

  <div class="card">
    <h2>Kp / Ki / Kd</h2>
    <div class="control">
      <label>Kp</label>
      <button onclick="adjustKValue('Kp', -0.1)">-</button>
      <span id="KpVal" class="val-box">5.0</span>
      <button onclick="adjustKValue('Kp', 0.1)">+</button>
      <input type="hidden" id="Kp" value="5.0">
    </div>
    <div class="control">
      <label>Ki</label>
      <button onclick="adjustKValue('Ki', -0.1)">-</button>
      <span id="KiVal" class="val-box">0.5</span>
      <button onclick="adjustKValue('Ki', 0.1)">+</button>
      <input type="hidden" id="Ki" value="0.5">
    </div>
    <div class="control">
      <label>Kd</label>
      <button onclick="adjustKValue('Kd', -0.1)">-</button>
      <span id="KdVal" class="val-box">1.0</span>
      <button onclick="adjustKValue('Kd', 0.1)">+</button>
      <input type="hidden" id="Kd" value="1.0">
    </div>
  </div>

  <script>
    // Configuration Firebase - À PERSONNALISER
    const firebaseConfig = {
      apiKey: "AIzaSyYOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialisation Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Initialisation des graphiques
    const tempChart = new Chart(document.getElementById('tempChart'), {
      type: 'doughnut',
      data: {
        datasets: [{
          data: [0, 100],
          backgroundColor: ['#e63946', '#f0f0f0']
        }]
      },
      options: {
        cutout: '75%',
        responsive: false,
        plugins: { legend: { display: false } }
      }
    });

    const humChart = new Chart(document.getElementById('humChart'), {
      type: 'doughnut',
      data: {
        datasets: [{
          data: [0, 100],
          backgroundColor: ['#457b9d', '#f0f0f0']
        }]
      },
      options: {
        cutout: '75%',
        responsive: false,
        plugins: { legend: { display: false } }
      }
    });

    // Gestion des valeurs Kp/Ki/Kd
    function adjustKValue(id, delta) {
      const current = parseFloat(document.getElementById(id).value);
      const max = id === 'Ki' ? 5 : 10;
      const newValue = Math.max(0, Math.min(current + delta, max));
      
      updateValue(id, newValue.toFixed(1));
      sendToFirebase(id, newValue.toFixed(1));
    }

    // Gestion de la consigne température
    function adjustValue(id, delta) {
      const current = parseInt(document.getElementById(id).value);
      const newValue = Math.max(30, Math.min(current + delta, 80));
      
      updateValue(id, newValue);
      sendToFirebase(id, newValue);
    }

    // Mise à jour de l'affichage
    function updateValue(id, value) {
      document.getElementById(id).value = value;
      document.getElementById(id + 'Val').textContent = 
        value + (id.includes('Temp') ? '°C' : '');
      
      // Mise à jour des graphiques si capteurs
      if (id === 'temp') {
        tempChart.data.datasets[0].data = [value, 100 - value];
        tempChart.update();
      }
      if (id === 'hum') {
        humChart.data.datasets[0].data = [value, 100 - value];
        humChart.update();
      }
    }

    // Envoi des données à Firebase
    function sendToFirebase(param, value) {
      database.ref('settings/' + param).set(parseFloat(value))
        .then(() => console.log(`${param} updated to ${value}`))
        .catch(error => console.error("Firebase error:", error));
    }

    // Écoute des données de l'ESP32
    function setupFirebaseListeners() {
      // Surveillance température/humidité
      database.ref('sensors').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          updateValue('temp', data.temperature.toFixed(1));
          updateValue('hum', data.humidity.toFixed(1));
          document.getElementById('connectionStatus').className = "connection-status connected";
          document.getElementById('connectionStatus').textContent = "ESP32 Connecté";
        }
      });

      // Chargement des paramètres initiaux
      database.ref('settings').once('value').then((snapshot) => {
        const settings = snapshot.val();
        if (settings) {
          if (settings.consigneTemp) updateValue('consigneTemp', settings.consigneTemp);
          if (settings.Kp) updateValue('Kp', settings.Kp);
          if (settings.Ki) updateValue('Ki', settings.Ki);
          if (settings.Kd) updateValue('Kd', settings.Kd);
        }
      });

      // Surveillance état connexion
      database.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === false) {
          document.getElementById('connectionStatus').className = "connection-status disconnected";
          document.getElementById('connectionStatus').textContent = "ESP32 Déconnecté";
        }
      });
    }

    // Démarrer l'application
    setupFirebaseListeners();
  </script>
</body>
</html>